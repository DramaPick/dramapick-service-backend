name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - master  # master ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout code
      uses: actions/checkout@v3
    
    # ì‹¤í–‰ í™˜ê²½ ì •ë¦¬
    - name: Cleanup GitHub Actions runner
      run: |
        rm -rf $GITHUB_WORKSPACE/*  # ì´ì „ ì‹¤í–‰ ê¸°ë¡ ì‚­ì œ

    - name: script
      run: ls -al

    # 2ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ
    - name: Build and Push Docker Image
      run: |
        docker build --no-cache -t fastapi-app .
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker tag fastapi-app ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest

    # 3ï¸âƒ£ EC2ì— í•„ìš”í•œ íŒŒì¼ ì—…ë¡œë“œ
    - name: Upload required files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "./docker-compose.yml"
        target: "/home/ec2-user/app/"

    - name: Upload Dockerfile to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "./Dockerfile"
        target: "/home/ec2-user/app/"

    # 3ï¸âƒ£-1 EC2 SSH ì—°ê²° í™•ì¸ ë° í™˜ê²½ ì„¤ì •
    - name: Check EC2 Environment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "âœ… SSH ì—°ê²° ì„±ê³µ!"
          echo "ğŸ”¹ í˜„ì¬ ì‚¬ìš©ì: $(whoami)"
          echo "ğŸ”¹ í˜¸ìŠ¤íŠ¸ ì •ë³´: $(hostname -I)"

          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
          if [ ! -d "/home/ec2-user/app" ]; then
            echo "ğŸ“‚ /home/ec2-user/app ë””ë ‰í„°ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
            mkdir -p /home/ec2-user/app
          fi
          ls -al /home/ec2-user/app  # ë””ë ‰í„°ë¦¬ ë‚´ìš© í™•ì¸

    # 4ï¸âƒ£ EC2ì— SSH ì ‘ì† í›„ ìµœì‹  Docker ì´ë¯¸ì§€ ë°°í¬
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        command_timeout: 500s
        script: |
          echo "ğŸš€ ë°°í¬ ì‹œì‘!"
          
          # ğŸ”¥ ë¶ˆí•„ìš”í•œ Docker ìºì‹œ ì‚­ì œ
          echo "ğŸ§¹ Docker ì‹œìŠ¤í…œ ì •ë¦¬ ì¤‘..."
          docker system prune -a -f --volumes
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ec2-user/app

          # ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          docker pull ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë° ë³¼ë¥¨ ì •ë¦¬ ì¤‘..."
          docker-compose down -v || true
          
          # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          for file in docker-compose.yml Dockerfile; do
            if [ ! -f "$file" ]; then
              echo "âš ï¸ $file íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
              exit 1
            fi
          done

          # .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°)
          cat <<EOF > .env
          AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          S3_REGION_NAME=${{ secrets.S3_REGION_NAME }}
          GPT_API_KEY=${{ secrets.GPT_API_KEY }}
          REDIS_HOST=redis
          REDIS_PORT=6379
          EOF
          
          # docker-compose ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x docker-compose.yml

          # ğŸ”¥ Docker Overlay2 ì •ë¦¬ (ë¶ˆí•„ìš”í•œ ë ˆì´ì–´ ì‚­ì œ)
          echo "ğŸ—‘ï¸ Overlay2 íŒŒì¼ ì •ë¦¬ ì¤‘..."
          docker volume rm $(docker volume ls -qf dangling=true) || true

          # ğŸ—ï¸ Docker Compose ì‹¤í–‰
          echo "ğŸš€ Docker Compose ì‹¤í–‰ ì¤‘..."
          docker-compose --env-file .env up -d

          echo "âœ… ë°°í¬ ì™„ë£Œ!"