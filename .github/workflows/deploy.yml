name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout code
      uses: actions/checkout@v3

    # 2ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ
    - name: Build and Push Docker Image
      run: |
        docker build -t fastapi-app .
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker tag fastapi-app ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest

    # 3ï¸âƒ£ EC2ì— SSH ì ‘ì† í›„ ìµœì‹  Docker ì´ë¯¸ì§€ ë°°í¬
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /path/to/your/project
          
          # ğŸ”¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          docker-compose down
          
          # ğŸ”¹ .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°)
          echo "AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}" > .env
          echo "AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}" >> .env
          echo "S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}" >> .env
          echo "S3_REGION_NAME=${{ secrets.S3_REGION_NAME }}" >> .env
          echo "GPT_API_KEY=${{ secrets.GPT_API_KEY }}" >> .env
          
          # ğŸ”¹ ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          docker pull ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest
          
          # ğŸ”¹ Docker Compose ì‹¤í–‰
          docker-compose up -d --build
