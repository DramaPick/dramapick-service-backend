name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - master  # master ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout code
      uses: actions/checkout@v3

    - name: List files for debugging
      run: ls -al

    # 2ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ
    - name: Build and Push Docker Image
      run: |
        docker build -t fastapi-app .
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker tag fastapi-app ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest

    # 3ï¸âƒ£ EC2ì— í•„ìš”í•œ íŒŒì¼ ì—…ë¡œë“œ
    - name: Upload docker-compose.yml to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "./docker-compose.yml"
        target: "/home/ec2-user/app/"
    
    # ì—…ë¡œë“œ
    - name: Upload Dockerfile to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "./Dockerfile"
        target: "/home/ec2-user/app/"

    # 3ï¸âƒ£-1 EC2 í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ë° ë””ë ‰í† ë¦¬ ì²´í¬
    - name: Test SSH Connection & Check Environment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "âœ… SSH ì—°ê²° ì„±ê³µ!"
          
          # ğŸ” EC2 í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          echo "ğŸ”¹ EC2_USER: $(whoami)"
          echo "ğŸ”¹ EC2_HOST: $(hostname -I)"

          if [ ! -d "/home/ec2-user/app" ]; then
            echo "ğŸ“‚ /home/ec2-user/app ë””ë ‰í„°ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
            mkdir -p /home/ec2-user/app
          fi
          ls -al /home/ec2-user/app  # ë””ë ‰í„°ë¦¬ ë‚´ìš© í™•ì¸

    # 4ï¸âƒ£ EC2ì— SSH ì ‘ì† í›„ ìµœì‹  Docker ì´ë¯¸ì§€ ë°°í¬
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        command_timeout: 500s
        script: |
          # ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
          docker system prune -a -f
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ec2-user/app

          # ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          docker pull ${{ secrets.DOCKER_USERNAME }}/fastapi-app:latest
          
          # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          for file in docker-compose.yml Dockerfile; do
            if [ ! -f "$file" ]; then
              echo "âš ï¸ $file íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
              exit 1
            fi
          done
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          docker-compose down || true
          
          # .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°)
          cat <<EOF > .env
          AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          S3_REGION_NAME=${{ secrets.S3_REGION_NAME }}
          GPT_API_KEY=${{ secrets.GPT_API_KEY }}
          REDIS_HOST=redis
          REDIS_PORT=6379
          EOF
          
          # docker-compose ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x docker-compose.yml
          
          # Docker Compose ì‹¤í–‰
          docker-compose --env-file .env up -d